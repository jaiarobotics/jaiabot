syntax = "proto2";

import "dccl/option_extensions.proto";
import "jaiabot/messages/mission.proto";
import "jaiabot/messages/geographic_coordinate.proto";
import "jaiabot/messages/high_control.proto";
import "goby/middleware/protobuf/coroner.proto";
import "jaiabot/messages/health.proto";
import "jaiabot/messages/imu.proto";

package jaiabot.protobuf;

message Command
{
    option (dccl.msg) = {
        id: 80
        max_bytes: 200
        codec_version: 3
        unit_system: "si"
    };

    required uint32 bot_id = 1 [(dccl.field) = { min: 0 max: 255 }];
    required uint64 time = 2 [(dccl.field) = {
        codec: "dccl.time2"
        units { prefix: "micro" derived_dimensions: "time" }
    }];

    enum CommandType
    {
        // pre mission
        MISSION_PLAN = 1;
        ACTIVATE = 2;
        START_MISSION = 3;
        MISSION_PLAN_FRAGMENT = 4;

        // during any mission
        NEXT_TASK = 10;
        RETURN_TO_HOME = 11;
        STOP = 12;

        // during remote control mission
        REMOTE_CONTROL_SETPOINT = 20;
        REMOTE_CONTROL_TASK = 21;
        REMOTE_CONTROL_RESUME_MOVEMENT = 22;

        // post mission
        RECOVERED = 30;
        SHUTDOWN = 31;
        RETRY_DATA_OFFLOAD = 32;

        // debugging low level commands
        RESTART_ALL_SERVICES = 40;
        REBOOT_COMPUTER = 41;
        SHUTDOWN_COMPUTER = 42;
    }

    required CommandType type = 10;

    // required for type == MISSION_PLAN
    optional MissionPlan plan = 20;

    // required for type == REMOTE_CONTROL_SETPOINT
    optional RemoteControl rc = 30;

    // required for type == REMOTE_CONTROL_TASK
    optional MissionTask rc_task = 31;
}

message CommandForHub
{
    option (dccl.msg) = {
        id: 90
        max_bytes: 200
        codec_version: 3
        unit_system: "si"
    };

    required uint32 hub_id = 1 [(dccl.field) = { min: 0 max: 255 }];
    required uint64 time = 2 [(dccl.field) = {
        codec: "dccl.time2"
        units { prefix: "micro" derived_dimensions: "time" }
    }];

    enum CommandType
    {
        // debugging low level commands
        RESTART_ALL_SERVICES = 40;
        REBOOT_COMPUTER = 41;
        SHUTDOWN_COMPUTER = 42;
    }

    required CommandType type = 10;
}

message BotStatus
{
    /*
    Actual maximum size of message: 52 bytes / 416 bits
            dccl.id head...........................8
            user head..............................0
            body.................................402
            padding to full byte...................6
    Allowed maximum size of message: 52 bytes / 416 bits
    */
    option (dccl.msg) = {
        id: 81
        max_bytes: 52
        codec_version: 3
        unit_system: "si"
    };

    required uint32 bot_id = 1 [(dccl.field) = { min: 0 max: 255 }];
    required uint64 time = 2 [(dccl.field) = {
        codec: "dccl.time2"
        units { prefix: "micro" derived_dimensions: "time" }
    }];
    optional uint64 last_command_time = 3 [(dccl.field) = {
        codec: "dccl.time2"
        units { prefix: "micro" derived_dimensions: "time" }
    }];

    optional goby.middleware.protobuf.HealthState health_state = 4;
    repeated Error error = 5 [(dccl.field).max_repeat = 5];
    repeated Warning warning = 6 [(dccl.field).max_repeat = 5];

    optional GeographicCoordinate location = 10;

    optional double depth = 11 [(dccl.field) = {
        min: -1
        max: 100
        precision: 1
        units: { derived_dimensions: "length" }
    }];

    message Attitude
    {
        optional double roll = 1 [(dccl.field) = {
            min: -180
            max: 180
            precision: 0
            units { derived_dimensions: "plane_angle" system: "angle::degree" }
        }];
        optional double pitch = 2 [(dccl.field) = {
            min: -180
            max: 180
            precision: 0
            units { derived_dimensions: "plane_angle" system: "angle::degree" }
        }];
        optional double heading = 3 [(dccl.field) = {
            min: 0
            max: 360
            precision: 0
            units { derived_dimensions: "plane_angle" system: "angle::degree" }
        }];
        optional double course_over_ground = 4 [(dccl.field) = {
            min: 0
            max: 360
            precision: 0
            units { derived_dimensions: "plane_angle" system: "angle::degree" }
        }];
    }
    optional Attitude attitude = 20;

    message Speed
    {
        optional double over_ground = 1 [(dccl.field) = {
            min: -5
            max: 10
            precision: 1
            units { derived_dimensions: "velocity" }
        }];
        optional double over_water = 2 [(dccl.field) = {
            min: -5
            max: 10
            precision: 1
            units { derived_dimensions: "velocity" }
        }];
    }
    optional Speed speed = 30;

    optional MissionState mission_state = 40;

    // bounds should match MissionPlan.goal max_repeat value * expected_fragments max
    optional int32 active_goal = 41 [(dccl.field) = { min: 0 max: 29 }];
    optional double distance_to_active_goal = 42 [(dccl.field) = {
        min: 0
        max: 1000
        precision: 1
        units: { derived_dimensions: "length" }
    }];
    optional uint32 active_goal_timeout = 43 [
        (dccl.field) = {
            min: 0
            max: 3600
            precision: 0
            units { base_dimensions: "T" }
        }
    ];

    optional double salinity = 51
        [(dccl.field) = { min: 0 max: 100 precision: 1 }];

    optional double temperature = 52 [(dccl.field) = {
        min: -50
        max: 100
        precision: 2
        units { derived_dimensions: "temperature" system: "celsius" }
    }];

    optional double thermocouple_temperature = 53 [(dccl.field) = {
        min: -50
        max: 100
        precision: 2
        units { derived_dimensions: "temperature" system: "celsius" }
    }];

    optional double vv_current = 54 [(dccl.field) = {
        min: -5
        max: 1000
        precision: 2
        units { derived_dimensions: "current" }
    }];

    optional double vcc_current = 55 [(dccl.field) = {
        min: -5
        max: 1000
        precision: 2
        units { derived_dimensions: "current" }
    }];

    optional double vcc_voltage = 56 [(dccl.field) = {
        min: 0
        max: 25
        precision: 2
        units { derived_dimensions: "electric_potential" system: "si" }
    }];

    optional IMUData.CalibrationStatus calibration_status = 58;
    
    optional double hdop = 59 [(dccl.field) = { min: 0 max: 100 precision: 2 }];

    optional double pdop = 60 [(dccl.field) = { min: 0 max: 100 precision: 2 }];

    optional double battery_percent = 57 [(dccl.field) = { 
        min: 0 
        max: 100 
        precision: 0
    }];
}

message DriftPacket
{
    option (dccl.msg) = {
        unit_system: "si"
    };

    optional int32 drift_duration = 1 [
        default = 0,
        (dccl.field) = {
            min: 0
            max: 3600
            precision: -1
            units { base_dimensions: "T" }
        }
    ];

    message EstimatedDrift
    {
        required double speed = 1 [(dccl.field) = {
            min: 0
            max: 10
            precision: 1
            units { derived_dimensions: "velocity" }
        }];

        optional double heading = 3 [(dccl.field) = {
            min: 0
            max: 360
            precision: 0
            units { derived_dimensions: "plane_angle" system: "angle::degree" }
        }];
    }

    // should correspond to ocean current velocity
    optional EstimatedDrift estimated_drift = 10;

    // location C
    optional GeographicCoordinate start_location = 11;
    // location D
    optional GeographicCoordinate end_location = 12;
}

message DivePacket
{
    option (dccl.msg) = {
        unit_system: "si"
    };

    required double dive_rate = 10 [(dccl.field) = {
        min: 0
        max: 10
        precision: 1
        units { derived_dimensions: "velocity" }
    }];

    optional double unpowered_rise_rate = 11 [(dccl.field) = {
        min: 0
        max: 10
        precision: 1
        units { derived_dimensions: "velocity" }
    }];

    optional double powered_rise_rate = 12 [(dccl.field) = {
        min: 0
        max: 10
        precision: 1
        units { derived_dimensions: "velocity" }
    }];

    required double depth_achieved = 13 [(dccl.field) = {
        min: 0
        max: 100
        precision: 1
        units: { derived_dimensions: "length" }
    }];

    message Measurements
    {
        optional double mean_depth = 1 [(dccl.field) = {
            min: 0
            max: 100
            precision: 1
            units: { derived_dimensions: "length" }
        }];

        optional double mean_temperature = 2 [(dccl.field) = {
            min: -1
            max: 50
            precision: 1
            units { derived_dimensions: "temperature" system: "celsius" }
        }];

        optional double mean_salinity = 3
            [(dccl.field) = { min: 0 max: 45 precision: 1 }];
    }

    repeated Measurements measurement = 14 [(dccl.field) = { max_repeat: 45 }];

    // location A
    optional GeographicCoordinate start_location = 15;

    optional double duration_to_acquire_gps = 16 [(dccl.field) = {
        min: 0
        max: 120
        precision: 1
        units { base_dimensions: "T" }
    }];

    // Did we reach seafloor?
    optional bool bottom_dive = 17 [default = false];

    // Did we reach min depth?
    optional bool reached_min_depth = 18 [default = false];

        // For bottom characterization
    optional double max_acceleration = 19
        [(dccl.field) = {units {
            derived_dimensions: "acceleration"
            system: "si"
            }}
        ];

}

message TaskPacket
{
    /*
    Actual maximum size of message: 197 bytes / 1576 bits
        dccl.id head..........................16
        user head..............................0
        body................................1559
        padding to full byte...................1
    Allowed maximum size of message: 200 bytes / 1600 bits
    */
    option (dccl.msg) = {
        id: 0x5001
        max_bytes: 200
        codec_version: 3
        unit_system: "si"
    };

    required uint32 bot_id = 1 [(dccl.field) = { min: 0 max: 255 }];
    required uint64 start_time = 2 [(dccl.field) = {
        codec: "dccl.time2"
        units { prefix: "micro" derived_dimensions: "time" }
    }];
    required uint64 end_time = 3 [(dccl.field) = {
        codec: "dccl.time2"
        units { prefix: "micro" derived_dimensions: "time" }
    }];
    required MissionTask.TaskType type = 4;

    optional DivePacket dive = 10;
    optional DriftPacket drift = 11;
}
