#!/bin/bash

## SSH Keys
mkdir -p /home/jaia/.ssh
cat << EOF >> /home/jaia/.ssh/authorized_keys
{{ ssh_pubkeys }}
EOF

## Set up VPN

node_type={{ item.node_type }}
FLEET_ID={{ cloud_env_vars.jaia_fleet_index }}
VIRTUALFLEET_VPN_SERVER_CIDR_48="fd6e:cf0d:aefa"
VIRTUALFLEET_VPN_CLIENT_IPV6={{ item.ipv6_address }}
VFLEET_VPN=wg_jaia_vfleet${FLEET_ID}

cat <<EOF > /etc/wireguard/${VFLEET_VPN}.conf
[Interface]
PrivateKey = {{ private_vpn_keys[item.node_type][item.node_id] }}

# this client's VPN IP address
Address = ${VIRTUALFLEET_VPN_CLIENT_IPV6}/128

[Peer]
# Server public key (from /etc/wireguard/publickey on server)
PublicKey = {{ cloud_env_vars.jaia_cloudhub_wg_pubkey }}

# Allowed private IPs
AllowedIPs = ${VIRTUALFLEET_VPN_SERVER_CIDR_48}::/48

# Server IP and port
Endpoint = {{ ansible_eth0.ipv6[0].address }}:51820

# Keep connection alive (required for behind NAT routers)
PersistentKeepalive = 52

EOF

systemctl enable wg-quick@${VFLEET_VPN}

## Preseed jaiabot
mount -o remount,rw /boot/firmware
mkdir -p /boot/firmware/jaiabot/init
cat << EOF | tee /boot/firmware/jaiabot/init/first-boot.preseed

jaia_run_first_boot=true
jaia_stress_tests=false

########################################################
# Network
########################################################
jaia_disable_ethernet=false
jaia_configure_wifi=false
jaia_wifi_ssid=dummy
jaia_wifi_password=dummy

#########################################################
# Preseed jaiabot-embedded package debconf queries
# See jaiabot-embedded.templates from jaiabot-debian 
# https://github.com/jaiarobotics/jaiabot-debian/blob/1.y/jaiabot-embedded.templates
# To dump config in the correct format on a bot that is configured use: "debconf-get-selections  | grep jaia"
#########################################################
jaia_install_jaiabot_embedded=true
jaia_embedded_debconf=\$(cat << EOM
jaiabot-embedded	jaiabot-embedded/fleet_id	select	{{ cloud_env_vars.jaia_fleet_index }}
jaiabot-embedded	jaiabot-embedded/type	select	{{ item.node_type }}
jaiabot-embedded	jaiabot-embedded/mode	select	simulation
jaiabot-embedded	jaiabot-embedded/warp	select	10
jaiabot-embedded	jaiabot-embedded/bot_id	select	{{ item.node_id }}
jaiabot-embedded	jaiabot-embedded/hub_id	select	{{ item.node_id }}
jaiabot-embedded	jaiabot-embedded/arduino_type	select	none
jaiabot-embedded	jaiabot-embedded/electronics_stack	select	2
jaiabot-embedded	jaiabot-embedded/led_type	select	none
EOM
)

jaia_reboot=true

EOF

systemctl restart first_boot
