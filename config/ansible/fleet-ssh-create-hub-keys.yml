---
- name: Generate or Copy SSH keys to Hubs
  hosts: hubs
  gather_facts: yes
  become: yes
  vars:
    SSH_KEY_TYPE: ed25519

  pre_tasks:
    - include_tasks: tasks/fleet-set-facts.yml

    - name: Check Yubikey files
      include_tasks: tasks/fleet-check-yubikey-files.yml
      when: USE_YUBIKEY
        
  tasks:    
    - name: Find all files in /media/root-rw/overlay/home/jaia/.ssh/
      ansible.builtin.find:
        paths: /media/root-rw/overlay/home/jaia/.ssh/
        file_type: file
      register: ssh_files_to_remove

    - name: Remove all overlay files we are going to modify
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ ssh_files_to_remove.files }}"

    - name: Remove overlay SSH files, known_hosts, and old keys
      shell: |
        {{ RO_ROOT_CMD }} rm -f {{ JAIA_SSH_DIR }}/known_hosts;
        {{ RO_CMD }} rm -f {{ HUB_DEST_KEYFILE }} {{ HUB_DEST_KEYFILE }}.pub;
        
    - name: Copy Yubikey (real fleet) or generate new SSH key (virtual fleet)
      block:
        - name: Copy Yubikey keys to hub
          when: USE_YUBIKEY
          synchronize:
            src: "{{ item.src }}"
            dest: "{{ item.dest }}"
            rsync_path: "sudo {{ RO_CMD }} rsync"
          loop:
            - { src: "{{ HUB_SRC_KEYFILE }}.pub", dest: "{{ HUB_DEST_KEYFILE }}.pub" }
            - { src: "{{ HUB_SRC_KEYFILE }}", dest: "{{ HUB_DEST_KEYFILE }}" }
              
        - name: Generate new SSH key for virtual fleet
          when: not USE_YUBIKEY
          shell: |
            {{ RO_CMD }} ssh-keygen -t {{ SSH_KEY_TYPE }} -N '' -f {{ HUB_DEST_KEYFILE }} -C {{ HUB_NAME }}
        
    - name: Ensure .ssh/config is configured to use the new SSH key
      shell: |
        {{ RO_CMD }} bash -c "touch /home/jaia/.ssh/config";
        {{ RO_CMD }} bash -c "touch /home/jaia/.ssh/config; grep -q IdentityFile\\ {{ HUB_DEST_KEYFILE }} /home/jaia/.ssh/config || echo IdentityFile {{ HUB_DEST_KEYFILE }} >> /home/jaia/.ssh/config";
